os:
  - linux
  - windows
  - osx

language: bash

before_install:
 - export TRAVIS_TAG="1.$TRAVIS_BUILD_NUMBER"
 - echo -n $TRAVIS_TAG > DRILL_VERSION

addons:

  #linux
  apt:
    packages:
      - desktop-file-utils
      - p7zip-full
  #osx
  homebrew:
    update: true
    packages:
      - dmd
      - gtk+3
      - dub
      - p7zip


script:

  #linux
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then bash build_linux.bash; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then ls -lah build; fi

  #windows
  - >
    if [ "$TRAVIS_OS_NAME" == "windows" ]; then 
      wget http://downloads.dlang.org/nightlies/dmd-master/dmd.master.windows.7z;
      7z x dmd.master.windows.7z;
      git clone https://github.com/yatima1460/GTK3-windows-32bit;
      cd source/cli
      ../../dmd2/windows/bin/dub build -b release --parallel --force --arch=x86
      cd ../../
      7z a -tzip ../../build/Drill-cli-windows-$TRAVIS_TAG-x86.zip assets drill-cli.exe;
      cd source/gtkui
      ../../dmd2/windows/bin/dub build -b release --parallel --force --arch=x86;
      cd ../../
      mv GTK3-windows-32bit/*.dll .;
      7z a -tzip ../../build/Drill-gtk-windows-$TRAVIS_TAG-x86.zip assets drill-gtk.exe DRILL_VERSION *.dll;
    fi

  #osx 
  - >
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      cd source/cli
      dub build -b release --parallel --force --arch=x86_64;
      cd ../../
      7z a -tzip ../../build/Drill-cli-osx-$TRAVIS_TAG-x86_64.zip assets drill-cli.mach-o DRILL_VERSION;
      cd source/gtkui
      dub build -b release --parallel --force --arch=x86_64;
      7z a -tzip ../../build/Drill-gtk-osx-$TRAVIS_TAG-x86_64.zip assets drill-gtk.mach-o DRILL_VERSION;
      cd ../../
    fi



before_deploy:
 - git config --local user.name "Federico Santamorena"
 - git config --local user.email "federico@santamorena.me"
 #- git tag "$TRAVIS_TAG" "$TRAVIS_COMMIT"

deploy:
  provider: releases
  skip_cleanup: true
  draft: false
  prerelease: true
  name: $TRAVIS_TAG
  body: Automated Travis build
  target_commitish: $TRAVIS_COMMIT
  file_glob: true
  api_key:
    secure: $GITHUB_TOKEN
  file: 
    - build/*.*
    
    #- tools/appimage/Drill-cli.AppImage
    #- Drill-cli-windows.zip
    #- Drill-gtk-windows.zip
    #- Drill-gtk-OSX.zip
    #- Drill-cli-OSX.zip
    
    
  on:
    repo: yatima1460/Drill

notifications:
  email:
    on_success: never
    on_failure: always
