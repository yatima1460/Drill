os:
- linux
- windows
language: bash

before_script:
- export TRAVIS_TAG="1.$TRAVIS_BUILD_NUMBER"
- echo -n $TRAVIS_TAG > DRILL_VERSION
- git config --local user.name "Federico Santamorena"
- git config --local user.email "federico@santamorena.me"
- git tag "$TRAVIS_TAG" "$TRAVIS_COMMIT"

script:

#windows
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then wget http://downloads.dlang.org/nightlies/dmd-master/dmd.master.windows.7z; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then 7z x dmd.master.windows.7z; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then git clone https://github.com/yatima1460/GTK-for-Windows-Runtime-Environment-Installer.git; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then dmd2/windows/bin/dub build -c CLI --build=release --parallel --force; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then 7z a -tzip -r Drill-CLI-Windows.zip assets/ Drill-CLI.exe; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then dmd2/windows/bin/dub build -c GTK --build=release --parallel --force; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then mv GTK-for-Windows-Runtime-Environment-Installer/gtk-nsis-pack/bin/*.dll .; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then 7z a -tzip -r Drill-GTK-Windows.zip assets/ Drill-GTK.exe DRILL_VERSION *.dll; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then test -f Drill-GTK-Windows.zip; fi
- if [ "$TRAVIS_OS_NAME" == "windows" ]; then test -f Drill-CLI-Windows.zip; fi

#linux
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt update; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt install desktop-file-utils; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then curl -fsS https://dlang.org/install.sh | bash -s dmd; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then source ~/dlang/dmd-2.086.0/activate; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then dub build -c CLI --build=release --parallel --force; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then 7z a -tzip -r Drill-CLI-Linux.zip assets Drill-CLI DRILL_VERSION; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd tools/appimage && sh cli.sh && cd ../../; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then dub build -c GTK --build=release --parallel --force; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then 7z a -tzip -r Drill-GTK-Linux.zip assets Drill-GTK DRILL_VERSION; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then cd tools/appimage && sh gtk.sh && cd ../../; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then test -f Drill-GTK-Linux.zip; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then test -f Drill-CLI-Linux.zip; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then test -f tools/appimage/Drill-GTK.AppImage; fi
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then test -f tools/appimage/Drill-CLI.AppImage; fi

deploy:
  provider: releases
  skip_cleanup: true
  draft: false
  prerelease: false
  tag_name: $TRAVIS_TAG
  target_commitish: $TRAVIS_COMMIT
  api_key:
    secure: $GITHUB_TOKEN
  file: 
    - tools/appimage/Drill-GTK.AppImage
    - tools/appimage/Drill-CLI.AppImage
    - Drill-GTK-Linux.zip
    - Drill-CLI-Linux.zip
    - Drill-CLI-Windows.zip
    - Drill-GTK-Windows.zip
    
  on:
    repo: yatima1460/Drill

notifications:
  email:
    on_success: never
    on_failure: always
