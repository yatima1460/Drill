branches:
  only:
  - master


os:
  - linux
  - windows
  - osx


language: bash


before_script:
 - export TRAVIS_TAG="1.$TRAVIS_BUILD_NUMBER"
 - echo -n $TRAVIS_TAG > DRILL_VERSION
 - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install ldc; fi
 - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install dub; fi
 - if [ "$TRAVIS_OS_NAME" = "windows" ]; then cd Tools && bash RefreshEnv.sh && cd ../; fi


addons:

  #linux
  apt:
    update: true
    packages:
      - desktop-file-utils
      - p7zip-full

  #osx
  homebrew:
    update: true
    packages:
      #- dmd
      #- dub
      - p7zip


script:

  # install D

  ## linux
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo snap install ldc2 --classic --channel=edge; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo snap install dmd --classic; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo snap install dub --classic; fi

  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then wget http://downloads.dlang.org/releases/2.x/2.086.0/dmd.2.086.0.linux.tar.xz; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then 7z x dmd.2.086.0.linux.tar.xz; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then 7z x dmd.2.086.0.linux.tar; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then export DUB="$PWD"/dmd2/linux/bin64/dub; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then chmod +x $DUB; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then chmod +x "$PWD"/dmd2/linux/bin64/dmd; fi

  ## windows
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then wget http://downloads.dlang.org/releases/2.x/2.086.0/dmd.2.086.0.windows.7z; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then 7z x dmd.2.086.0.windows.7z; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then move "$PWD"/dmd2/windows/bin/*.* $PWD; fi

  ## osx
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then wget http://downloads.dlang.org/releases/2.x/2.086.0/dmd.2.086.0.osx.tar.xz; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then 7z x dmd.2.086.0.osx.tar.xz; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then 7z x dmd.2.086.0.osx.tar; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then export DUB="$PWD"/dmd2/osx/bin/dub; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then chmod +x $DUB; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then chmod +x "$PWD"/dmd2/osx/bin/dmd; fi

  # build

  ## build CLI
  - cd Source/Frontend/CLI
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then dub  build -b release --arch=x86_64; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ];     then $DUB build -b release --arch=x86_64; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ];   then dub  build -b release --arch=x86_64 --compiler=ldc2; fi
  - cd ../../../

  ## build UI

  ### Linux
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd Source/Frontend/GTK; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then dub build -b release --arch=x86_64 --compiler=ldc2; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd ../../../; fi

  ### Windows
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then cd Source/Frontend/WinAPI; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then $DUB build --arch=x86; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then $DUB build --arch=x86_64; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then $DUB build -b release --arch=x86; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then $DUB build -b release --arch=x86_64; fi
  # - if [ "$TRAVIS_OS_NAME" = "windows" ]; then cd ../../../; fi

  ### OSX


  # build installers/packages

  # zip files
  - cd Tools/zip
  - bash create_zips.bash
  - cd ../../

  ## linux

  ### deb
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd Tools/deb; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then bash build_deb_cli.bash; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then bash build_deb_gtk.bash; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd ../../; fi

  ### AppImage
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd Tools/AppImage; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then bash build_appimage_gtk.bash; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd ../../; fi

  ### rpm
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd Tools/rpm; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then bash build_rpm.bash; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then cd ../../; fi

  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ; fi
  # - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ; fi
  


before_deploy:
 - git config --local user.name "Federico Santamorena"
 - git config --local user.email "federico@santamorena.me"

deploy:
  provider: releases
  skip_cleanup: true
  draft: false
  prerelease: true
  name: $TRAVIS_TAG
  body: $TRAVIS_COMMIT_MESSAGE
  target_commitish: $TRAVIS_COMMIT
  file_glob: true
  api_key:
    secure: $GITHUB_TOKEN
  file: 
    - Tools/deb/Build/*.deb
    # - Tools/rpm/Build/*.rpm
    - Tools/AppImage/Build/*.AppImage
    - Tools/zip/Build/*.zip

  on:
    repo: yatima1460/Drill

notifications:
  email:
    on_success: never
    on_failure: always
