
language: bash

os:
  - windows
  - linux
  - osx

env:
  - DMD_VERSION=2.087.1
  - MAIN_VERSION=2


before_cache:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew cleanup; fi;
  # - DIR="$PWD/dmd2"
  # - if [! -d "$DIR" ]; then source ./.travis/install_d.bash; fi;

cache:
  directories:
    - $HOME/Library/Caches/Homebrew
    # - $PWD/dmd2

script:
   # DO NOT USE "bash" here, but use "source"
   # so we can change global variables like PATH in sub-scripts
   - source .travis/install_d.bash
   - dub test -c CLI
   - echo CLI Unittest
   - source .travis/install_gtk.bash
   - dub test -c GTK
   - echo GTK Unittest
   - dub build -c CLI -b release-travis
   - echo CLI Release
   - 7z a -tzip Drill-$MAIN_VERSION.$TRAVIS_BUILD_NUMBER-CLI-$TRAVIS_OS_NAME-x86_64.zip $PWD/Build/Drill-GTK-$TRAVIS_OS_NAME-x86_64-release-travis/*
   - dub build -c GTK -b release-travis
   - echo GTK Release
   - 7z a -tzip Drill-$MAIN_VERSION.$TRAVIS_BUILD_NUMBER-GTK-$TRAVIS_OS_NAME-x86_64.zip $PWD/Build/Drill-CLI-$TRAVIS_OS_NAME-x86_64-release-travis/*
   # if this is a pull request we stop here
   - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then travis_terminate 1; fi
   
   - curl -T Drill-$MAIN_VERSION.$TRAVIS_BUILD_NUMBER-CLI-$TRAVIS_OS_NAME-x86_64.zip -uyatima1460:$BINTRAY_API_KEY https://api.bintray.com/content/yatima1460/Drill/Portable-Beta/$MAIN_VERSION.$TRAVIS_BUILD_NUMBER/Drill-$MAIN_VERSION.$TRAVIS_BUILD_NUMBER-CLI-$TRAVIS_OS_NAME-x86_64.zip
   - curl -X POST -uyatima1460:$BINTRAY_API_KEY https://api.bintray.com/content/yatima1460/Drill/Portable-Beta/$MAIN_VERSION.$TRAVIS_BUILD_NUMBER/publish
  #  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bash ./.travis/rolling_release.bash; fi
   
